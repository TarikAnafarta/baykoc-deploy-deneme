name: CI - Tests (Backend + Frontend)

on:
  push:
    branches: ["production", "dev"]
  pull_request:
    branches: ["*"]

permissions:
  contents: read

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  backend-tests:
    name: Backend (Django + PostgreSQL)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: baykoc_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      CI: true
      DJANGO_SETTINGS_MODULE: backend.settings_ci
      DB_ENGINE: django.db.backends.postgresql
      DB_NAME: baykoc_test
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: 127.0.0.1
      DB_PORT: "5432"
      SECRET_KEY: test-secret
      DEBUG: "False"
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Django system checks
        run: |
          python manage.py check --fail-level WARNING

      - name: Run migrations
        run: |
          python manage.py migrate --noinput

      - name: Run tests (pytest)
        run: |
          pytest backend/ -v

  frontend-tests:
    name: Frontend (Vite/Node)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      CI: true
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Node.js (LTS)
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci --no-audit --no-fund || npm ci --no-audit --no-fund --legacy-peer-deps; else npm install --no-audit --no-fund || npm install --no-audit --no-fund --legacy-peer-deps; fi

      - name: Frontend tests
        run: |
          npm run -s test --if-present

      - name: Build (ensure Vite app compiles)
        run: |
          npm run -s build --if-present
